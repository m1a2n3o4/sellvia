// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// SUPER ADMIN TABLES
// ============================================

model Admin {
  id            String   @id @default(uuid())
  username      String   @unique
  passwordHash  String   @map("password_hash")
  email         String?  @unique
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("admins")
}

model Tenant {
  id           String   @id @default(uuid())
  clientName   String   @map("client_name")
  businessName String   @map("business_name")
  mobile       String   @unique
  passwordHash      String   @map("password_hash")
  pinChangeRequired Boolean  @default(true) @map("pin_change_required")
  address           String
  status       TenantStatus
  features     Json     @default("{\"inventory\":true,\"orders\":true,\"customers\":true,\"broadcasting\":false,\"whatsapp\":false}")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  products         Product[]
  productVariants  ProductVariant[]
  customers        Customer[]
  orders           Order[]
  orderItems       OrderItem[]
  whatsappChats    WhatsAppChat[]
  whatsappMessages WhatsAppMessage[]
  businessInfo     BusinessInfo?

  @@index([status])
  @@index([createdAt])
  @@map("tenants")
}

enum TenantStatus {
  active
  inactive
}

model OtpVerification {
  id        String   @id @default(uuid())
  mobile    String
  otp       String
  expiresAt DateTime @map("expires_at")
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([mobile])
  @@map("otp_verifications")
}

// ============================================
// TENANT-SCOPED TABLES
// ============================================

model Product {
  id                 String   @id @default(uuid())
  tenantId           String   @map("tenant_id")
  name               String
  brand              String?
  description        String?
  category           String?
  basePrice          Decimal  @map("base_price") @db.Decimal(10, 2)
  sku                String?
  stockQuantity      Int      @default(0) @map("stock_quantity")
  lowStockThreshold  Int      @default(10) @map("low_stock_threshold")
  images             Json     @default("[]")
  status             ProductStatus @default(active)
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  variants    ProductVariant[]
  orderItems  OrderItem[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([sku])
  @@map("products")
}

enum ProductStatus {
  active
  inactive
}

model ProductVariant {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  productId     String   @map("product_id")
  variantName   String   @map("variant_name")
  sku           String?
  price         Decimal  @db.Decimal(10, 2)
  stockQuantity Int      @default(0) @map("stock_quantity")
  attributes    Json     // {"Color": "Black", "RAM": "16GB"}
  status        ProductStatus @default(active)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@index([tenantId])
  @@index([productId])
  @@index([tenantId, productId])
  @@map("product_variants")
}

model Customer {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  name        String
  mobile      String
  email       String?
  address     String?
  city        String?
  state       String?
  pincode     String?
  notes       String?
  totalOrders Int      @default(0) @map("total_orders")
  totalSpent  Decimal  @default(0) @map("total_spent") @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders Order[]

  @@unique([tenantId, mobile])
  @@index([tenantId])
  @@index([tenantId, createdAt(sort: Desc)])
  @@map("customers")
}

model Order {
  id               String   @id @default(uuid())
  tenantId         String   @map("tenant_id")
  orderNumber      String   @map("order_number")
  customerId       String   @map("customer_id")
  orderDate        DateTime @default(now()) @map("order_date")
  status           OrderStatus @default(pending)
  paymentMethod    String?  @map("payment_method")
  paymentStatus    PaymentStatus @default(unpaid) @map("payment_status")
  subtotal         Decimal  @db.Decimal(10, 2)
  discount         Decimal  @default(0) @db.Decimal(10, 2)
  shippingFee      Decimal  @default(0) @map("shipping_fee") @db.Decimal(10, 2)
  tax              Decimal  @default(0) @db.Decimal(10, 2)
  total            Decimal  @db.Decimal(10, 2)
  orderType        OrderType @default(offline) @map("order_type")
  deliveryAddress  String?  @map("delivery_address")
  deliveryStatus   DeliveryStatus @default(pending) @map("delivery_status")
  notes            String?
  cancelledReason        String?  @map("cancelled_reason")
  cancelledAt            DateTime? @map("cancelled_at")
  chatId                 String?  @map("chat_id")
  razorpayPaymentLinkId  String?  @map("razorpay_payment_link_id")
  razorpayPaymentId      String?  @map("razorpay_payment_id")
  cashfreeLinkId         String?  @map("cashfree_link_id")
  cashfreePaymentId      String?  @map("cashfree_payment_id")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer   Customer    @relation(fields: [customerId], references: [id], onDelete: Restrict)
  orderItems OrderItem[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([tenantId, status])
  @@index([tenantId, orderDate(sort: Desc)])
  @@index([tenantId, orderType])
  @@index([paymentStatus])
  @@index([razorpayPaymentLinkId])
  @@index([cashfreeLinkId])
  @@map("orders")
}

enum OrderStatus {
  pending
  confirmed
  shipped
  delivered
  cancelled
}

enum PaymentStatus {
  paid
  unpaid
  pending
  failed
  refunded
}

enum OrderType {
  online
  offline
}

enum DeliveryStatus {
  pending
  dispatched
  in_transit
  delivered
  returned
}

model OrderItem {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  orderId      String   @map("order_id")
  productId    String   @map("product_id")
  variantId    String?  @map("variant_id")
  productName  String   @map("product_name")
  variantName  String?  @map("variant_name")
  price        Decimal  @db.Decimal(10, 2)
  quantity     Int
  subtotal     Decimal  @db.Decimal(10, 2)
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([orderId])
  @@index([productId])
  @@index([tenantId, orderId])
  @@map("order_items")
}

// ============================================
// WHATSAPP AI COMMERCE TABLES
// ============================================

model WhatsAppChat {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  customerPhone   String   @map("customer_phone")
  customerName    String?  @map("customer_name")
  lastMessage     String?  @map("last_message")
  lastMessageAt   DateTime? @map("last_message_at")
  unreadCount     Int      @default(0) @map("unread_count")
  status          ChatStatus @default(active)
  needsAttention  Boolean  @default(false) @map("needs_attention")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages          WhatsAppMessage[]
  conversationState ConversationState?

  @@unique([tenantId, customerPhone])
  @@index([tenantId])
  @@index([tenantId, lastMessageAt(sort: Desc)])
  @@index([tenantId, status])
  @@index([tenantId, needsAttention])
  @@map("whatsapp_chats")
}

enum ChatStatus {
  active
  archived
}

model WhatsAppMessage {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  chatId      String   @map("chat_id")
  waMessageId String?  @map("wa_message_id")
  sender      MessageSender
  senderPhone String?  @map("sender_phone")
  content     String
  messageType MessageType @default(text) @map("message_type")
  mediaUrl    String?  @map("media_url")
  status      MessageStatus @default(sent)
  isAiGenerated Boolean @default(false) @map("is_ai_generated")
  createdAt   DateTime @default(now()) @map("created_at")

  metadata    Json?    // stores orderId, productId, paymentLink for rich message rendering

  // Relations
  tenant Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  chat   WhatsAppChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([chatId])
  @@index([chatId, createdAt])
  @@index([tenantId, createdAt(sort: Desc)])
  @@map("whatsapp_messages")
}

enum MessageSender {
  customer
  business
  ai
}

enum MessageType {
  text
  image
  document
  audio
  video
  location
  interactive
}

enum MessageStatus {
  sent
  delivered
  read
  failed
}

model BusinessInfo {
  id           String   @id @default(uuid())
  tenantId     String   @unique @map("tenant_id")
  storeName    String?  @map("store_name")
  description  String?
  storeHours   String?  @map("store_hours")
  location     String?
  locationUrl  String?  @map("location_url")
  policies     String?
  greeting     String?
  whatsappPhoneNumberId String? @map("whatsapp_phone_number_id")
  whatsappBusinessId    String? @map("whatsapp_business_id")
  whatsappToken         String? @map("whatsapp_token")
  openaiKey             String? @map("openai_key")
  aiEnabled             Boolean  @default(true) @map("ai_enabled")
  razorpayKeyId         String?  @map("razorpay_key_id")
  razorpayKeySecret     String?  @map("razorpay_key_secret")
  cashfreeAppId         String?  @map("cashfree_app_id")
  cashfreeSecretKey     String?  @map("cashfree_secret_key")
  paymentGateway        String?  @default("none") @map("payment_gateway")
  platformFeePercent    Float?   @default(0) @map("platform_fee_percent")
  whatsappAppSecret     String?  @map("whatsapp_app_secret")
  ownerPhone            String?  @map("owner_phone")
  aiCustomInstructions  String?  @map("ai_custom_instructions")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("business_info")
}

enum ConversationStep {
  idle
  product_shown
  awaiting_quantity
  awaiting_address
  awaiting_payment
  order_complete
}

model ConversationState {
  id             String           @id @default(uuid())
  chatId         String           @unique @map("chat_id")
  step           ConversationStep @default(idle)
  productId      String?          @map("product_id")
  variantId      String?          @map("variant_id")
  quantity       Int?
  deliveryAddress String?         @map("delivery_address")
  orderId        String?          @map("order_id")
  paymentLinkId  String?          @map("payment_link_id")
  paymentLinkUrl String?          @map("payment_link_url")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  createdAt      DateTime         @default(now()) @map("created_at")

  // Relations
  chat WhatsAppChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([updatedAt])
  @@map("conversation_states")
}

// ============================================
// LANDING PAGE TABLES
// ============================================

model Enquiry {
  id            String        @id @default(uuid())
  name          String
  mobile        String
  instagramLink String?       @map("instagram_link")
  website       String?
  message       String?
  status        EnquiryStatus @default(pending)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("enquiries")
}

enum EnquiryStatus {
  pending
  contacted
  converted
  closed
}

model PageView {
  id        String   @id @default(uuid())
  page      String   @default("/")
  country   String?
  state     String?
  city      String?
  device    String?
  browser   String?
  referrer  String?
  ip        String?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([country])
  @@map("page_views")
}
